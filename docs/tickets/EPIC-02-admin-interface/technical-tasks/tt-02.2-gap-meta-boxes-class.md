# TT-02.2: Implement GAP_Meta_Boxes Class

**Ticket ID:** TT-02.2
**Epic:** EPIC-02 (Custom Post Type & Admin Interface)
**Estimated Time:** 2.5 hours
**Status:** Not Started

---

## Overview

Create the GAP_Meta_Boxes class that manages all meta box functionality for tracking script configuration including field rendering, saving, sanitization, and validation.

---

## File Location

`includes/class-gap-meta-boxes.php`

---

## Implementation Steps

1. Create class with singleton pattern
2. Implement add_meta_boxes() action hook
3. Create render_script_config_meta_box() method
4. Implement save_meta_boxes() with full sanitization
5. Add enqueue_admin_assets() method for CSS/JS
6. Hook to WordPress actions

---

## Methods to Implement

### get_instance() - Singleton Pattern
- Static method returning single instance
- Creates instance on first call

### __construct() - Register Hooks
- Private constructor (singleton)
- Register 'add_meta_boxes' hook
- Register 'save_post_tracking_script' hook
- Register 'admin_enqueue_scripts' hook

### add_meta_boxes() - Register Meta Box
- Register meta box on 'tracking_script' post type
- Title: "Tracking Script Configuration"
- Priority: 'high'
- Context: 'normal'

### render_script_config_meta_box() - Render HTML
- Output nonce field for security
- Get post meta values
- Render Script Content textarea
- Render Placement dropdown
- Render Scope dropdown
- Render Target Pages checkboxes (hidden by default)
- Render Is Active checkbox
- Output CSS for initial page selector display

### save_meta_boxes() - Save with Sanitization
- Verify nonce for security
- Check user capability (manage_options)
- Verify post type is tracking_script
- Sanitize and validate each field:
  - Script Content: wp_kses_post()
  - Placement: sanitize_text_field() + whitelist check
  - Scope: sanitize_text_field() + whitelist check
  - Target Pages: array_map('absint')
  - Is Active: presence check (0 or 1)
- Save all meta using update_post_meta()

### enqueue_admin_assets() - Load CSS/JS
- Check hook (post.php, post-new.php)
- Check post type (tracking_script)
- Enqueue assets/js/admin.js
- Enqueue assets/css/admin.css
- Add body class for JS detection

---

## Security Implementation

1. **Nonce Verification**
   - wp_nonce_field() in render method
   - wp_verify_nonce() in save method

2. **Capability Checks**
   - current_user_can('manage_options')
   - Only admins can save

3. **Input Sanitization**
   - wp_kses_post() for script content
   - sanitize_text_field() for dropdowns
   - array_map('absint') for page IDs

4. **Output Escaping**
   - esc_textarea() for textarea values
   - esc_attr() for attribute values
   - esc_html() for HTML text

5. **Validation**
   - Whitelist allowed values for dropdowns
   - Validate page IDs exist
   - Prevent invalid data storage

---

## Meta Fields Configuration

| Field | Key | Type | Sanitization | Validation |
|-------|-----|------|--------------|-----------|
| Script Content | _gap_script_content | textarea | wp_kses_post() | None (allow GA/GTM) |
| Placement | _gap_placement | select | sanitize_text_field() | Must be in whitelist |
| Scope | _gap_scope | select | sanitize_text_field() | Must be in whitelist |
| Target Pages | _gap_target_pages | array | array_map('absint') | Page IDs must exist |
| Is Active | _gap_is_active | boolean | Presence check | 0 or 1 only |

---

## Testing Requirements

### Rendering
- [ ] Meta box appears on new post page
- [ ] Meta box appears on edit post page
- [ ] All 5 fields render correctly
- [ ] All fields have labels and descriptions
- [ ] Nonce field present

### Data Persistence
- [ ] Script content saves correctly
- [ ] Placement selection saves correctly
- [ ] Scope selection saves correctly
- [ ] Selected pages save correctly
- [ ] Is Active checkbox saves correctly
- [ ] All values persist after reload

### Sanitization
- [ ] Script tags allowed in content field
- [ ] Dangerous attributes stripped
- [ ] Invalid placement values rejected
- [ ] Invalid scope values rejected
- [ ] Page IDs converted to integers

### Security
- [ ] Nonce verification blocks tampering
- [ ] Non-admin cannot save (403)
- [ ] Direct access to file blocked
- [ ] XSS attempts fail

### UI
- [ ] Page selector hidden when scope = global
- [ ] Page selector shown when scope = specific_pages
- [ ] Selected pages still selected after toggle
- [ ] Active checkbox works correctly

---

## Success Criteria

- [ ] GAP_Meta_Boxes class fully implemented
- [ ] All meta fields render correctly
- [ ] All fields save and persist correctly
- [ ] Nonce verification working
- [ ] Capability checks in place
- [ ] Input sanitization complete
- [ ] All acceptance criteria passing
- [ ] Code passes standards review

---

## Related Tickets

**Blocks:**
- US-02.3: Meta fields configuration
- US-02.4: Dynamic UI (depends on rendered form)

**Blocked By:**
- TT-02.1: GAP_CPT class (meta box attached to post type)

---

**Created:** 2025-10-16
**Expected Completion:** 2.5 hours
**Complexity:** High (security, sanitization, multiple fields)
