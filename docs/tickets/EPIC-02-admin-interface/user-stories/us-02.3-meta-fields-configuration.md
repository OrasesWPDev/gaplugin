# US-02.3: Configure Tracking Scripts via Meta Fields

**Ticket ID:** US-02.3
**Epic:** EPIC-02 (Custom Post Type & Admin Interface)
**Priority:** P0 (Critical)
**Story Points:** 8
**Status:** Not Started

---

## User Story

As an administrator, I need to configure tracking scripts via meta fields so that I can specify script content, placement, scope, and target pages for each tracking script.

---

## Acceptance Criteria

- [ ] Meta box appears on tracking script edit screen
- [ ] Script Content textarea accepts GA4 and GTM code
- [ ] Placement dropdown displays 4 options (head, body_top, body_bottom, footer)
- [ ] Scope dropdown displays 2 options (global, specific_pages)
- [ ] Page selector appears when scope is "specific_pages"
- [ ] Page selector is hidden when scope is "global"
- [ ] Active/Inactive checkbox present and functional
- [ ] All fields have proper labels and descriptions
- [ ] All fields save correctly when post is published
- [ ] All field values persist after save and reload
- [ ] All user inputs are sanitized before saving
- [ ] Nonce verification prevents CSRF attacks
- [ ] Only administrators can save meta fields

---

## Implementation Tasks

| # | Task | Time Est | Status |
|---|------|----------|--------|
| 1 | Create GAP_Meta_Boxes class skeleton | 30 min | ⏳ |
| 2 | Implement add_meta_boxes() action | 20 min | ⏳ |
| 3 | Create render_script_config_meta_box() method | 120 min | ⏳ |
| 4 | Implement save_meta_boxes() with sanitization | 90 min | ⏳ |
| 5 | Add nonce verification | 15 min | ⏳ |
| 6 | Add capability checks | 10 min | ⏳ |
| 7 | Test all fields save and persist | 30 min | ⏳ |

**Total Estimated Time:** 315 minutes (5.25 hours)

---

## Meta Fields Configuration

| Field | Key | Type | Required | Sanitization | Options |
|-------|-----|------|----------|--------------|---------|
| Script Content | _gap_script_content | textarea | Yes | wp_kses_post() | N/A |
| Placement | _gap_placement | select | Yes | sanitize_text_field() | head, body_top, body_bottom, footer |
| Scope | _gap_scope | select | Yes | sanitize_text_field() | global, specific_pages |
| Target Pages | _gap_target_pages | checkboxes | Conditional | array_map('absint') | All published pages |
| Is Active | _gap_is_active | checkbox | No | Presence check | 0 or 1 |

---

## Field Rendering

### Script Content Field
```php
<textarea
    name="gap_script_content"
    rows="10"
    placeholder="Paste your GA4 or GTM code here..."
><?php echo esc_textarea($script_content); ?></textarea>
```

### Placement Field
```php
<select name="gap_placement" id="gap_placement">
    <option value="">-- Select Placement --</option>
    <option value="head">Head</option>
    <option value="body_top">Body Top</option>
    <option value="body_bottom">Body Bottom</option>
    <option value="footer">Footer</option>
</select>
```

### Scope Field
```php
<select name="gap_scope" id="gap_scope">
    <option value="">-- Select Scope --</option>
    <option value="global">Global (All Pages)</option>
    <option value="specific_pages">Specific Pages</option>
</select>
```

### Target Pages Field
```php
<div class="gap-pages-selector" style="display: none;">
    <?php foreach ($pages as $page): ?>
        <label>
            <input type="checkbox"
                   name="gap_target_pages[]"
                   value="<?php echo $page->ID; ?>"
                   <?php checked(in_array($page->ID, $selected_pages)); ?>>
            <?php echo esc_html($page->post_title); ?>
        </label>
    <?php endforeach; ?>
</div>
```

### Is Active Field
```php
<label>
    <input type="checkbox"
           name="gap_is_active"
           value="1"
           <?php checked($is_active, '1'); ?>>
    Active (Script will be output on frontend)
</label>
```

---

## Sanitization & Validation

### Script Content
```php
$content = wp_kses_post(wp_unslash($_POST['gap_script_content']));
// Allows safe HTML and scripts, strips dangerous attributes
```

### Placement
```php
$placement = sanitize_text_field($_POST['gap_placement']);
$allowed = array('head', 'body_top', 'body_bottom', 'footer');
if (in_array($placement, $allowed, true)) {
    update_post_meta($post_id, '_gap_placement', $placement);
}
```

### Scope
```php
$scope = sanitize_text_field($_POST['gap_scope']);
$allowed = array('global', 'specific_pages');
if (in_array($scope, $allowed, true)) {
    update_post_meta($post_id, '_gap_scope', $scope);
}
```

### Target Pages
```php
$target_pages = array();
if (isset($_POST['gap_target_pages']) && is_array($_POST['gap_target_pages'])) {
    $target_pages = array_map('absint', $_POST['gap_target_pages']);
}
update_post_meta($post_id, '_gap_target_pages', $target_pages);
```

### Is Active
```php
$is_active = isset($_POST['gap_is_active']) ? '1' : '0';
update_post_meta($post_id, '_gap_is_active', $is_active);
```

---

## Security Implementation

- [ ] Nonce field: wp_nonce_field()
- [ ] Nonce verification: wp_verify_nonce()
- [ ] Capability check: current_user_can('manage_options')
- [ ] Input sanitization: wp_kses_post(), sanitize_text_field()
- [ ] Output escaping: esc_html(), esc_attr(), esc_textarea()
- [ ] Prevent autosave conflicts
- [ ] Validate all inputs against whitelist

---

## Testing Checklist

### Field Rendering
- [ ] Navigate to new tracking script page
- [ ] Verify meta box appears on edit screen
- [ ] Verify all 5 fields are present
- [ ] Verify all fields have labels
- [ ] Verify all fields have descriptions

### Field Functionality
- [ ] Script Content field accepts GA4 code
- [ ] Script Content field accepts GTM code
- [ ] Placement dropdown has 4 options
- [ ] Scope dropdown has 2 options
- [ ] Active checkbox can be checked/unchecked

### Dynamic UI
- [ ] Page selector hidden when page loads (scope default = global)
- [ ] Page selector shown when scope changed to "specific_pages"
- [ ] Page selector hidden when scope changed back to "global"
- [ ] Transition is smooth (uses show/hide, not page reload)

### Data Persistence
- [ ] Fill all fields with test data
- [ ] Publish tracking script
- [ ] Reload page
- [ ] Verify all field values persisted
- [ ] Edit script and verify values still there

### Sanitization
- [ ] Attempt XSS in Script Content field
- [ ] Verify script tags remain but dangerous attributes stripped
- [ ] Attempt SQL injection in other fields
- [ ] Verify injected code sanitized
- [ ] Save and reload to verify stored safely

### Security
- [ ] Attempt to access edit page as non-admin (should fail)
- [ ] Attempt direct meta box file access (should fail)
- [ ] Verify nonce field present
- [ ] Attempt to bypass nonce (should fail)

---

## Dependencies

**Upstream:**
- US-02.1: Custom post type registration
- TT-02.1: GAP_CPT class

**Downstream:**
- US-02.4: Dynamic UI (depends on this for scope selector)
- TT-02.2: GAP_Meta_Boxes class (this story is implementation)

---

## Definition of Done

- [ ] GAP_Meta_Boxes class created and fully implemented
- [ ] All 5 meta fields render correctly
- [ ] All fields have proper labels and descriptions
- [ ] Nonce verification implemented
- [ ] Capability checks implemented
- [ ] All inputs sanitized before saving
- [ ] All fields save and persist correctly
- [ ] All acceptance criteria passing
- [ ] Manual testing completed
- [ ] Security testing completed
- [ ] Code follows WordPress standards
- [ ] Ready for US-02.4 (dynamic UI)

---

**Files to Create:**
- `includes/class-gap-meta-boxes.php` (main implementation)

**Files to Modify:**
- `ga-plugin.php` (instantiate GAP_Meta_Boxes)

---

**Created:** 2025-10-16
**Last Updated:** 2025-10-16
**Complexity:** High (security, sanitization, multiple fields)
**Estimated Completion:** ~5.25 hours from start
