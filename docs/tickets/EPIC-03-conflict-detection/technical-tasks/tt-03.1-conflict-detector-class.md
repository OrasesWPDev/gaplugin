# TT-03.1: Implement GAP_Conflict_Detector Class

**Ticket Type:** Technical Task
**Epic:** EPIC-03 Conflict Detection System
**Time Estimate:** 2 hours
**File:** `includes/class-gap-conflict-detector.php`

## Description

Implement the core GAP_Conflict_Detector class that provides all conflict detection functionality including tracking ID extraction, duplicate detection, HTML scanning, and conflict logging.

This class serves as the central hub for all duplicate detection features and will be used by both admin and frontend components.

## Implementation Steps

1. Create class with singleton pattern
2. Add private $detected_conflicts property
3. Implement extract_tracking_ids() method
4. Implement check_global_conflicts() method
5. Implement scan_page_html() method
6. Implement get_conflicts() method
7. Implement log_conflict() method
8. Hook admin_init for conflict checking

## Class Structure

```php
<?php
/**
 * Conflict Detection for GA Plugin
 *
 * Detects duplicate tracking IDs across scripts and in page HTML.
 *
 * @package   GA_Plugin
 * @author    Orases
 * @copyright 2025 Orases
 * @license   GPL-2.0-or-later
 * @since     1.0.0
 */

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

class GAP_Conflict_Detector {
    /**
     * Singleton instance
     *
     * @var GAP_Conflict_Detector|null
     */
    private static $instance = null;

    /**
     * Detected conflicts cache
     *
     * @var array
     */
    private $detected_conflicts = array();

    /**
     * Get singleton instance
     *
     * @since 1.0.0
     * @return GAP_Conflict_Detector
     */
    public static function get_instance() {
        if (null === self::$instance) {
            self::$instance = new self();
        }
        return self::$instance;
    }

    /**
     * Constructor
     *
     * @since 1.0.0
     */
    private function __construct() {
        add_action('admin_init', array($this, 'check_global_conflicts'));
    }

    /**
     * Extract tracking IDs from script content
     *
     * @since 1.0.0
     * @param string $content The script content to analyze
     * @return array Array of tracking ID objects
     */
    public function extract_tracking_ids($content) {
        // Implementation from US-03.1
    }

    /**
     * Check for duplicate tracking IDs across all scripts
     *
     * @since 1.0.0
     * @return array Array of conflict data
     */
    public function check_global_conflicts() {
        // Implementation from US-03.4
    }

    /**
     * Scan page HTML for existing tracking scripts
     *
     * @since 1.0.0
     * @param string $html The page HTML content
     * @param array $tracking_ids Array of tracking IDs to check for
     * @return array Array of found tracking IDs
     */
    public function scan_page_html($html, $tracking_ids) {
        // Implementation from US-03.5
    }

    /**
     * Get detected conflicts
     *
     * @since 1.0.0
     * @return array Array of conflicts
     */
    public function get_conflicts() {
        return $this->detected_conflicts;
    }

    /**
     * Log conflict message to debug log
     *
     * @since 1.0.0
     * @param string $message The conflict message to log
     * @return void
     */
    public function log_conflict($message) {
        // Implementation from US-03.6
    }
}
```

## Method Implementations

### extract_tracking_ids()

**Regex Patterns:**
- GA4: `/['\"]G-[A-Z0-9]{10}['\""]/`
- GTM: `/['\"]GTM-[A-Z0-9]{7}['\""]/`

**Return Format:**
```php
[
    [
        'id' => 'G-ABC1234567',
        'type' => 'ga4',
        'name' => 'Google Analytics 4'
    ]
]
```

### check_global_conflicts()

**Logic:**
1. Query all published tracking_script posts
2. Loop through and get _gap_extracted_ids for each
3. Build map: tracking_id => array of post IDs using it
4. Find tracking IDs used by 2+ posts
5. Store in $this->detected_conflicts
6. Return conflicts array

### scan_page_html()

**Logic:**
1. Accept HTML string and tracking IDs array
2. Loop through tracking IDs
3. Use stripos() for case-insensitive search
4. Return array of found IDs

### get_conflicts()

**Logic:**
- Return $this->detected_conflicts property
- Used by admin notice system

### log_conflict()

**Logic:**
1. Check if WP_DEBUG is true
2. If true, use error_log() with "GAP Conflict:" prefix
3. Include relevant context in message

## Testing Checklist

- [ ] Class loads via autoloader
- [ ] Singleton pattern works correctly
- [ ] extract_tracking_ids() returns correct format
- [ ] check_global_conflicts() detects duplicates
- [ ] scan_page_html() finds IDs in HTML
- [ ] get_conflicts() returns cached conflicts
- [ ] log_conflict() only logs when WP_DEBUG enabled
- [ ] All methods have proper docblocks
- [ ] Code follows WordPress coding standards

## File Header

```php
<?php
/**
 * Conflict Detection for GA Plugin
 *
 * @package   GA_Plugin
 * @author    Orases
 * @copyright 2025 Orases
 * @license   GPL-2.0-or-later
 * @since     1.0.0
 */

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}
```

## Integration Points

### Used By:
- GAP_Meta_Boxes: For automatic ID extraction on save
- GAP_Admin: For displaying conflict notices
- GAP_Frontend: For HTML scanning before output

### Depends On:
- Autoloader (from EPIC-01)

## Security Considerations

- [ ] ABSPATH check at top of file
- [ ] No direct SQL queries (using get_posts)
- [ ] All output properly escaped when used in admin
- [ ] No sensitive data in logs

## Performance Considerations

- [ ] Conflicts cached in class property
- [ ] Not recalculated on every admin_notices call
- [ ] scan_page_html() uses efficient stripos()
- [ ] Regex patterns optimized

## Definition of Done

- [ ] Class file created
- [ ] All methods implemented
- [ ] Singleton pattern working
- [ ] All docblocks complete
- [ ] Code passes PHPCS
- [ ] Manual testing complete
- [ ] Integrated with autoloader
- [ ] PR review complete
- [ ] Ready to merge

## Notes

Generated: 2025-10-16

This is the core class for conflict detection. All other conflict-related features depend on this implementation.
