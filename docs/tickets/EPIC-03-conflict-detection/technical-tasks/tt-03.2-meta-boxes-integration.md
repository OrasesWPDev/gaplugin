# TT-03.2: Integrate Conflict Detector with Meta Boxes Save Handler

**Ticket Type:** Technical Task
**Epic:** EPIC-03 Conflict Detection System
**Time Estimate:** 30 minutes
**File:** `includes/class-gap-meta-boxes.php`

## Description

Integrate the GAP_Conflict_Detector class into the meta boxes save handler to automatically extract tracking IDs and generate content hashes whenever a tracking script is saved.

This ensures that every tracking script is immediately analyzed for tracking IDs without requiring manual intervention.

## Implementation Steps

1. Call Conflict_Detector after saving script content
2. Extract IDs and save to post meta
3. Generate content hash and save to post meta
4. Ensure extraction happens on every save

## Code Integration

### Location in save_meta_boxes()

After the script content is saved, add:

```php
/**
 * Save tracking script meta boxes
 *
 * @since 1.0.0
 * @param int $post_id The post ID
 * @return void
 */
public function save_meta_boxes($post_id) {
    // Existing nonce verification
    if (!isset($_POST['gap_meta_box_nonce'])) {
        return;
    }

    if (!wp_verify_nonce($_POST['gap_meta_box_nonce'], 'gap_save_meta_box')) {
        return;
    }

    // Existing capability check
    if (!current_user_can('manage_options', $post_id)) {
        return;
    }

    // Existing autosave check
    if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) {
        return;
    }

    // Save script content
    if (isset($_POST['gap_script_content'])) {
        $content = wp_kses_post(wp_unslash($_POST['gap_script_content']));
        update_post_meta($post_id, '_gap_script_content', $content);

        // ============================================
        // CONFLICT DETECTOR INTEGRATION STARTS HERE
        // ============================================

        // Extract tracking IDs
        $detector = GAP_Conflict_Detector::get_instance();
        $extracted_ids = $detector->extract_tracking_ids($content);
        update_post_meta($post_id, '_gap_extracted_ids', $extracted_ids);

        // Generate unique hash for duplicate detection
        $unique_hash = md5($content);
        update_post_meta($post_id, '_gap_unique_hash', $unique_hash);

        // ============================================
        // CONFLICT DETECTOR INTEGRATION ENDS HERE
        // ============================================
    }

    // Existing code for other meta fields...
}
```

## Post Meta Fields Created

### _gap_extracted_ids
**Type:** Array
**Structure:**
```php
[
    [
        'id' => 'G-ABC1234567',
        'type' => 'ga4',
        'name' => 'Google Analytics 4'
    ],
    [
        'id' => 'GTM-XYZ7890',
        'type' => 'gtm',
        'name' => 'Google Tag Manager'
    ]
]
```

### _gap_unique_hash
**Type:** String
**Format:** MD5 hash (32 characters)
**Example:** `5d41402abc4b2a76b9719d911017c592`

## Testing Checklist

### Test Case 1: Save with GA4 Code
1. Create new tracking script
2. Enter GA4 code: `gtag('config', 'G-ABC1234567');`
3. Click Save
4. Verify `_gap_extracted_ids` contains GA4 ID
5. Verify `_gap_unique_hash` is MD5 of content

### Test Case 2: Save with GTM Code
1. Create new tracking script
2. Enter GTM code with ID: `GTM-ABC1234`
3. Click Save
4. Verify `_gap_extracted_ids` contains GTM ID
5. Verify hash generated

### Test Case 3: Save with No IDs
1. Create new tracking script
2. Enter generic JavaScript (no tracking IDs)
3. Click Save
4. Verify `_gap_extracted_ids` is empty array
5. Verify hash still generated

### Test Case 4: Update Existing Script
1. Open existing tracking script
2. Change tracking ID from G-111 to G-222
3. Click Update
4. Verify `_gap_extracted_ids` updated with new ID
5. Verify hash updated

### Test Case 5: Multiple IDs
1. Create tracking script
2. Enter code with both GA4 and GTM IDs
3. Click Save
4. Verify `_gap_extracted_ids` contains both IDs
5. Verify correct types assigned

## Error Handling

### If Conflict_Detector Not Available
```php
if (class_exists('GAP_Conflict_Detector')) {
    $detector = GAP_Conflict_Detector::get_instance();
    $extracted_ids = $detector->extract_tracking_ids($content);
    update_post_meta($post_id, '_gap_extracted_ids', $extracted_ids);
} else {
    // Fallback: save empty array
    update_post_meta($post_id, '_gap_extracted_ids', array());
}
```

## Dependencies

- TT-03.1: GAP_Conflict_Detector class must exist
- EPIC-02: Meta Boxes class must exist
- Autoloader must be functional

## Integration Points

### Before This Integration:
- Script content saved to _gap_script_content
- Other meta fields saved (placement, scope, etc.)

### After This Integration:
- Script content still saved (no change)
- Tracking IDs automatically extracted
- Content hash automatically generated
- Data available for conflict detection

## Performance Considerations

- Extraction happens only on save (not on every page load)
- MD5 hash generation is fast
- Regex extraction is efficient
- No database queries in extraction logic

## Security Considerations

- Uses existing nonce verification
- Uses existing capability checks
- Content already sanitized with wp_kses_post()
- No new security risks introduced

## Definition of Done

- [ ] Code integrated into save_meta_boxes()
- [ ] Extraction happens on every save
- [ ] Post meta fields created correctly
- [ ] All test cases passing
- [ ] Error handling in place
- [ ] Code follows WordPress standards
- [ ] PR review complete
- [ ] Ready to merge

## Notes

Generated: 2025-10-16

This integration is critical - it ensures every tracking script is automatically analyzed as soon as it's saved, enabling immediate conflict detection.
