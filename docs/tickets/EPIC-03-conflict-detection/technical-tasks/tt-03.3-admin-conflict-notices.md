# TT-03.3: Implement Admin Conflict Notices

**Ticket Type:** Technical Task
**Epic:** EPIC-03 Conflict Detection System
**Time Estimate:** 1 hour
**File:** `includes/class-gap-admin.php`

## Description

Implement admin notice functionality to display warnings when duplicate tracking IDs are detected across multiple tracking scripts. The notice should appear on tracking_script admin pages and provide clear information about conflicts with edit links.

This provides administrators with immediate visual feedback about tracking ID conflicts directly in the WordPress admin interface.

## Implementation Steps

1. Hook admin_notices action
2. Check if on tracking_script admin page
3. Get conflicts from Conflict_Detector
4. Render admin notice HTML
5. Include edit links for affected posts
6. Add inline CSS for styling

## Code Implementation

### Add Method to GAP_Admin Class

```php
/**
 * Display conflict notices in admin
 *
 * @since 1.0.0
 * @return void
 */
public function display_conflict_notices() {
    // Only show on tracking_script admin pages
    $screen = get_current_screen();
    if (!$screen || 'tracking_script' !== $screen->post_type) {
        return;
    }

    // Get conflicts from detector
    $detector = GAP_Conflict_Detector::get_instance();
    $conflicts = $detector->get_conflicts();

    if (empty($conflicts)) {
        return;
    }

    // Render admin notice
    ?>
    <div class="notice notice-error gap-conflict-notice">
        <h3><?php esc_html_e('⚠️ Duplicate Tracking IDs Detected!', 'ga-plugin'); ?></h3>
        <p><?php esc_html_e('The following tracking IDs are used in multiple tracking scripts:', 'ga-plugin'); ?></p>

        <ul class="gap-conflict-list">
            <?php foreach ($conflicts as $conflict): ?>
                <li>
                    <strong>
                        <?php echo esc_html($conflict['tracking_id']); ?>
                        (<?php echo esc_html($conflict['name']); ?>)
                    </strong>
                    <?php esc_html_e('is used in:', 'ga-plugin'); ?>
                    <ul>
                        <?php foreach ($conflict['posts'] as $post_data): ?>
                            <li>
                                <?php echo esc_html($post_data['title']); ?>
                                <a href="<?php echo esc_url(get_edit_post_link($post_data['post_id'])); ?>">
                                    (<?php esc_html_e('edit', 'ga-plugin'); ?>)
                                </a>
                            </li>
                        <?php endforeach; ?>
                    </ul>
                </li>
            <?php endforeach; ?>
        </ul>

        <p class="gap-conflict-recommendation">
            <strong><?php esc_html_e('Recommendation:', 'ga-plugin'); ?></strong>
            <?php esc_html_e('Each tracking script should use a unique tracking ID to prevent data accuracy issues.', 'ga-plugin'); ?>
        </p>
    </div>

    <style>
        .gap-conflict-notice {
            border-left-color: #dc3232;
        }
        .gap-conflict-notice h3 {
            margin-top: 0;
            color: #dc3232;
        }
        .gap-conflict-list {
            margin: 15px 0;
        }
        .gap-conflict-list > li {
            margin-bottom: 15px;
        }
        .gap-conflict-list ul {
            margin-top: 5px;
            margin-left: 20px;
        }
        .gap-conflict-list ul li {
            list-style-type: disc;
        }
        .gap-conflict-recommendation {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin-top: 15px;
        }
    </style>
    <?php
}
```

### Register Hook in Constructor

```php
/**
 * Constructor
 *
 * @since 1.0.0
 */
private function __construct() {
    // Existing hooks...

    // Add conflict notices
    add_action('admin_notices', array($this, 'display_conflict_notices'));
}
```

## Notice Display Examples

### Example 1: Single Conflict
```
⚠️ Duplicate Tracking IDs Detected!

The following tracking IDs are used in multiple tracking scripts:

• G-ABC1234567 (Google Analytics 4) is used in:
  - Homepage GA4 Tracking (edit)
  - Global GA4 Script (edit)

Recommendation: Each tracking script should use a unique tracking ID to prevent data accuracy issues.
```

### Example 2: Multiple Conflicts
```
⚠️ Duplicate Tracking IDs Detected!

The following tracking IDs are used in multiple tracking scripts:

• G-ABC1234567 (Google Analytics 4) is used in:
  - Homepage GA4 Tracking (edit)
  - Global GA4 Script (edit)

• GTM-XYZ7890 (Google Tag Manager) is used in:
  - Product Page GTM (edit)
  - Checkout GTM (edit)
  - Thank You Page GTM (edit)

Recommendation: Each tracking script should use a unique tracking ID to prevent data accuracy issues.
```

## CSS Styling Details

### Notice Container
- Red left border (`#dc3232`)
- Error notice styling
- White background

### Heading
- Red color (`#dc3232`)
- Warning emoji (⚠️)
- No top margin

### Conflict List
- Nested unordered lists
- Disc bullets for post titles
- 15px spacing between conflicts

### Recommendation Box
- Yellow background (`#fff3cd`)
- Yellow left border (`#ffc107`)
- 10px padding
- 15px top margin

## Testing Checklist

### Test Case 1: No Conflicts
1. Create 3 scripts with different tracking IDs
2. Go to tracking scripts list
3. Verify no admin notice appears

### Test Case 2: Single Conflict
1. Create 2 scripts with same GA4 ID
2. Go to tracking scripts list
3. Verify error notice displays
4. Verify both scripts listed
5. Verify edit links work

### Test Case 3: Multiple Conflicts
1. Create scripts with 2 different duplicate IDs
2. Go to tracking scripts list
3. Verify notice shows both conflicts
4. Verify all scripts listed correctly

### Test Case 4: Edit Link Functionality
1. Create duplicate scripts
2. View conflict notice
3. Click edit link
4. Verify navigates to post edit page

### Test Case 5: Other Admin Pages
1. Create duplicate scripts
2. Go to Posts page
3. Verify no conflict notice (only on tracking_script pages)
4. Go to Pages page
5. Verify no conflict notice

### Test Case 6: Styling
1. Create duplicate scripts
2. View notice
3. Verify red border and heading
4. Verify yellow recommendation box
5. Verify proper spacing and formatting

## Screen Check Logic

```php
// Only show on tracking_script admin pages
$screen = get_current_screen();
if (!$screen || 'tracking_script' !== $screen->post_type) {
    return;
}
```

**Displays On:**
- Tracking Scripts list page
- Add New Tracking Script page
- Edit Tracking Script page

**Does NOT Display On:**
- Posts list
- Pages list
- Media library
- Other post types
- Settings pages

## Dependencies

- TT-03.1: GAP_Conflict_Detector class must exist
- GAP_Admin class must exist
- WordPress admin_notices hook

## Integration Points

### Data Source:
- GAP_Conflict_Detector::get_conflicts()

### Display Location:
- WordPress admin_notices area (above page content)

### User Actions:
- Click edit links to modify conflicting scripts

## Security Considerations

- [ ] All output properly escaped (esc_html, esc_url)
- [ ] Edit links use get_edit_post_link() (built-in security)
- [ ] Only shows to users who can see tracking_script post type
- [ ] No sensitive data exposed

## Performance Considerations

- Conflicts already cached in Conflict_Detector
- No additional database queries
- Inline CSS minimal (< 1KB)
- Only renders on tracking_script pages

## Internationalization

All strings wrapped with translation functions:
- `esc_html_e()` for output with echo
- Text domain: `'ga-plugin'`

## Definition of Done

- [ ] Code added to GAP_Admin class
- [ ] Hook registered in constructor
- [ ] All test cases passing
- [ ] Styling correct across browsers
- [ ] Edit links functional
- [ ] Only displays on correct pages
- [ ] All strings translatable
- [ ] Code follows WordPress standards
- [ ] PR review complete
- [ ] Ready to merge

## Notes

Generated: 2025-10-16

This admin notice is critical for user experience - it proactively alerts administrators to conflicts before they cause tracking issues on the frontend.
