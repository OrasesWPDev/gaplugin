# US-03.2: Automatic Tracking ID Extraction on Save

**Ticket Type:** User Story
**Epic:** EPIC-03 Conflict Detection System
**Story Points:** 3
**Time Estimate:** 65 minutes

## Description

As an administrator, I need tracking IDs automatically extracted when I save a script so that the system can immediately detect and track potential conflicts without manual intervention.

This automation ensures that every tracking script is analyzed for tracking IDs as soon as it's saved, storing the extracted IDs in post meta for use by the conflict detection system.

## Acceptance Criteria

- [ ] IDs extracted on every save_post_tracking_script action
- [ ] Extracted IDs stored in _gap_extracted_ids post meta
- [ ] Content hash stored in _gap_unique_hash post meta
- [ ] Extraction happens before meta boxes save completes
- [ ] Multiple saves update IDs correctly

## Implementation Tasks

- [ ] Hook into save_post_tracking_script in Meta_Boxes class (15 min)
- [ ] Call extract_tracking_ids() with script content (10 min)
- [ ] Store extracted IDs in post meta (15 min)
- [ ] Generate and store MD5 hash of content (10 min)
- [ ] Test extraction on save (15 min)

## Technical Details

### Integration Point (in GAP_Meta_Boxes)

```php
// After saving script content
$content = wp_kses_post(wp_unslash($_POST['gap_script_content']));
update_post_meta($post_id, '_gap_script_content', $content);

// Extract tracking IDs
$detector = GAP_Conflict_Detector::get_instance();
$extracted_ids = $detector->extract_tracking_ids($content);
update_post_meta($post_id, '_gap_extracted_ids', $extracted_ids);

// Generate unique hash
$unique_hash = md5($content);
update_post_meta($post_id, '_gap_unique_hash', $unique_hash);
```

## Test Cases

### Test Case 1: Save with GA4 Script
1. Create new tracking script
2. Enter GA4 code with tracking ID
3. Click Save
4. Verify _gap_extracted_ids contains GA4 ID
5. Verify _gap_unique_hash contains MD5 hash

### Test Case 2: Update Existing Script
1. Open existing tracking script
2. Change tracking ID
3. Click Update
4. Verify _gap_extracted_ids updated with new ID
5. Verify _gap_unique_hash updated

### Test Case 3: Save with No IDs
1. Create new tracking script
2. Enter generic JavaScript (no tracking IDs)
3. Click Save
4. Verify _gap_extracted_ids is empty array
5. Verify _gap_unique_hash still generated

## Dependencies

- US-03.1: Extract Tracking IDs (must be complete first)
- EPIC-02: Admin Interface (requires Meta_Boxes class)

## Definition of Done

- [ ] Code complete and tested
- [ ] Meets WordPress coding standards
- [ ] Hook properly registered
- [ ] All test cases passing
- [ ] PR review complete
- [ ] Ready to merge

## Notes

Generated: 2025-10-16

The content hash enables quick comparison for detecting duplicate scripts without analyzing the full content each time.
