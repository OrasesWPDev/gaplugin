# US-03.4: Admin Warnings for Duplicate Tracking IDs

**Ticket Type:** User Story
**Epic:** EPIC-03 Conflict Detection System
**Story Points:** 5
**Time Estimate:** 165 minutes

## Description

As an administrator, I need warnings when duplicate tracking IDs are detected so that I can identify and resolve conflicts before they cause double-tracking issues on the frontend.

This provides proactive notification in the admin interface when the same tracking ID is being used by multiple tracking scripts, helping prevent data accuracy issues.

## Acceptance Criteria

- [ ] check_global_conflicts() scans all published tracking scripts
- [ ] Detects when same tracking ID used in multiple posts
- [ ] Admin notice displays on tracking_script admin pages
- [ ] Notice lists all posts using duplicate IDs
- [ ] Notice includes edit links for each post
- [ ] Recommendation provided to fix conflicts

## Implementation Tasks

- [ ] Implement check_global_conflicts() method (75 min)
- [ ] Create admin notice in GAP_Admin class (45 min)
- [ ] Hook admin_init to run conflict check (10 min)
- [ ] Add CSS for error notice styling (15 min)
- [ ] Test with duplicate IDs (20 min)

## Technical Details

### check_global_conflicts() Logic

1. Query all published tracking_script posts
2. Loop through and get _gap_extracted_ids for each
3. Build map: tracking_id => array of post IDs using it
4. Find tracking IDs used by 2+ posts
5. Return array of conflicts

### Implementation

```php
public function check_global_conflicts() {
    $args = array(
        'post_type'      => 'tracking_script',
        'post_status'    => 'publish',
        'posts_per_page' => -1,
    );

    $scripts = get_posts($args);
    $id_map = array();

    foreach ($scripts as $script) {
        $extracted_ids = get_post_meta($script->ID, '_gap_extracted_ids', true);

        if (is_array($extracted_ids)) {
            foreach ($extracted_ids as $id_data) {
                $tracking_id = $id_data['id'];

                if (!isset($id_map[$tracking_id])) {
                    $id_map[$tracking_id] = array(
                        'type' => $id_data['type'],
                        'name' => $id_data['name'],
                        'posts' => array()
                    );
                }

                $id_map[$tracking_id]['posts'][] = array(
                    'post_id' => $script->ID,
                    'title'   => $script->post_title
                );
            }
        }
    }

    $conflicts = array();
    foreach ($id_map as $tracking_id => $data) {
        if (count($data['posts']) > 1) {
            $conflicts[] = array(
                'tracking_id' => $tracking_id,
                'type'        => $data['type'],
                'name'        => $data['name'],
                'posts'       => $data['posts']
            );
        }
    }

    return $conflicts;
}
```

### Admin Notice Format

```
⚠️ Duplicate Tracking IDs Detected!

The following tracking IDs are used in multiple tracking scripts:

• G-ABC1234567 (Google Analytics 4) is used in:
  - Homepage GA4 Tracking (edit)
  - Global GA4 Script (edit)

Recommendation: Each tracking script should use a unique tracking ID.
```

## Test Cases

### Test Case 1: No Duplicates
1. Create 3 scripts with different tracking IDs
2. Go to tracking scripts list
3. Verify no admin notice appears

### Test Case 2: Single Duplicate
1. Create 2 scripts with same GA4 ID
2. Go to tracking scripts list
3. Verify admin notice displays
4. Verify shows both script titles
5. Verify edit links work

### Test Case 3: Multiple Duplicates
1. Create scripts: A and B use G-111, C and D use GTM-222
2. Go to tracking scripts list
3. Verify notice shows both conflicts
4. Verify all 4 scripts listed correctly

### Test Case 4: Three Scripts Same ID
1. Create 3 scripts with same tracking ID
2. Go to tracking scripts list
3. Verify notice lists all 3 scripts

## Dependencies

- US-03.1: Extract Tracking IDs
- US-03.2: Automatic ID Extraction
- EPIC-02: Admin Interface

## Definition of Done

- [ ] Code complete and tested
- [ ] Meets WordPress coding standards
- [ ] Admin notice properly styled
- [ ] All test cases passing
- [ ] Edit links functional
- [ ] PR review complete
- [ ] Ready to merge

## Notes

Generated: 2025-10-16

This is a key differentiator for the plugin - proactive conflict detection helps prevent data accuracy issues before they occur.
