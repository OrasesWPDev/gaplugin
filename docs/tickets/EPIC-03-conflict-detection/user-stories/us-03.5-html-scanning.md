# US-03.5: Scan Page HTML for Existing Tracking Scripts

**Ticket Type:** User Story
**Epic:** EPIC-03 Conflict Detection System
**Story Points:** 3
**Time Estimate:** 100 minutes

## Description

As a developer, I need to scan page HTML for existing tracking scripts so that the system can detect tracking codes added by themes or other plugins before outputting additional scripts.

This enables the plugin to prevent duplicate tracking by checking if tracking IDs already exist anywhere in the page HTML before adding them again.

## Acceptance Criteria

- [ ] scan_page_html() accepts HTML string and tracking IDs
- [ ] Searches HTML for each tracking ID (case-insensitive)
- [ ] Returns array of found IDs
- [ ] Handles large HTML strings efficiently
- [ ] Works across all DOM sections (head, body, footer)

## Implementation Tasks

- [ ] Implement scan_page_html() method (45 min)
- [ ] Use stripos() for case-insensitive search (15 min)
- [ ] Test with sample HTML containing GA4 (15 min)
- [ ] Test with sample HTML containing GTM (15 min)
- [ ] Test with empty HTML (10 min)

## Technical Details

### Method Signature

```php
/**
 * Scan page HTML for existing tracking scripts
 *
 * @param string $html The page HTML content
 * @param array $tracking_ids Array of tracking IDs to check for
 * @return array Array of found tracking IDs
 */
public function scan_page_html($html, $tracking_ids) {
    $found_ids = array();

    if (empty($html) || !is_array($tracking_ids)) {
        return $found_ids;
    }

    foreach ($tracking_ids as $id_data) {
        $tracking_id = $id_data['id'];

        // Case-insensitive search
        if (stripos($html, $tracking_id) !== false) {
            $found_ids[] = $id_data;
        }
    }

    return $found_ids;
}
```

## Test Cases

### Test Case 1: ID Found in HTML
**Input:**
```php
$html = '<script>gtag("config", "G-ABC1234567");</script>';
$tracking_ids = [
    ['id' => 'G-ABC1234567', 'type' => 'ga4', 'name' => 'Google Analytics 4']
];
```

**Expected Output:**
```php
[
    ['id' => 'G-ABC1234567', 'type' => 'ga4', 'name' => 'Google Analytics 4']
]
```

### Test Case 2: ID Not Found
**Input:**
```php
$html = '<script>console.log("test");</script>';
$tracking_ids = [
    ['id' => 'G-ABC1234567', 'type' => 'ga4', 'name' => 'Google Analytics 4']
];
```

**Expected Output:**
```php
[]
```

### Test Case 3: Multiple IDs, Some Found
**Input:**
```php
$html = '<script>gtag("config", "G-ABC1234567");</script>';
$tracking_ids = [
    ['id' => 'G-ABC1234567', 'type' => 'ga4', 'name' => 'Google Analytics 4'],
    ['id' => 'GTM-XYZ7890', 'type' => 'gtm', 'name' => 'Google Tag Manager']
];
```

**Expected Output:**
```php
[
    ['id' => 'G-ABC1234567', 'type' => 'ga4', 'name' => 'Google Analytics 4']
]
```

### Test Case 4: Case Insensitive Match
**Input:**
```php
$html = '<script>gtag("config", "g-abc1234567");</script>'; // lowercase
$tracking_ids = [
    ['id' => 'G-ABC1234567', 'type' => 'ga4', 'name' => 'Google Analytics 4']
];
```

**Expected Output:**
```php
[
    ['id' => 'G-ABC1234567', 'type' => 'ga4', 'name' => 'Google Analytics 4']
]
```

### Test Case 5: Empty HTML
**Input:**
```php
$html = '';
$tracking_ids = [
    ['id' => 'G-ABC1234567', 'type' => 'ga4', 'name' => 'Google Analytics 4']
];
```

**Expected Output:**
```php
[]
```

## Performance Considerations

- Use `stripos()` (fast, built-in function)
- No regex needed for this search (simple string matching)
- Efficient even with large HTML strings (10,000+ characters)
- No DOM parsing required

## Dependencies

- US-03.1: Extract Tracking IDs (defines ID data structure)

## Definition of Done

- [ ] Code complete and tested
- [ ] Meets WordPress coding standards
- [ ] All test cases passing
- [ ] Performance validated with large HTML
- [ ] Inline documentation complete
- [ ] PR review complete
- [ ] Ready to merge

## Notes

Generated: 2025-10-16

This method will be heavily used by EPIC-04 (Frontend Output) to prevent duplicate tracking scripts on the frontend.
