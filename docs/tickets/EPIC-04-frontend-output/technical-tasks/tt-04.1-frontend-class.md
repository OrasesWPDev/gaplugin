# TT-04.1: Implement GAP_Frontend Class

**Ticket Type:** Technical Task
**Epic:** EPIC-04 Frontend Script Output
**Time Estimate:** 3 hours
**File:** `includes/class-gap-frontend.php`

## Description

Implement the core GAP_Frontend class that handles all frontend script output functionality including querying active scripts, filtering by scope, detecting duplicates, and outputting scripts at correct WordPress hooks.

This class is the main engine for frontend script delivery and brings together all previous work to deliver the core plugin functionality.

## Implementation Steps

1. Create class with singleton pattern
2. Add private $scripts_cache property
3. Implement get_active_scripts($placement) method
4. Implement output_scripts($placement) method
5. Implement get_current_page_html() helper method
6. Create placement-specific wrapper methods
7. Register WordPress action hooks

## Class Structure

```php
<?php
/**
 * Frontend Script Output for GA Plugin
 *
 * Handles outputting tracking scripts on the frontend with duplicate detection.
 *
 * @package   GA_Plugin
 * @author    Orases
 * @copyright 2025 Orases
 * @license   GPL-2.0-or-later
 * @since     1.0.0
 */

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

class GAP_Frontend {
    /**
     * Singleton instance
     *
     * @var GAP_Frontend|null
     */
    private static $instance = null;

    /**
     * Scripts cache (request-level)
     *
     * @var array
     */
    private $scripts_cache = array();

    /**
     * Get singleton instance
     *
     * @since 1.0.0
     * @return GAP_Frontend
     */
    public static function get_instance() {
        if (null === self::$instance) {
            self::$instance = new self();
        }
        return self::$instance;
    }

    /**
     * Constructor
     *
     * @since 1.0.0
     */
    private function __construct() {
        $this->register_hooks();
    }

    /**
     * Register WordPress hooks
     *
     * @since 1.0.0
     * @return void
     */
    private function register_hooks() {
        add_action('wp_head', array($this, 'output_head_scripts'), 1);
        add_action('wp_body_open', array($this, 'output_body_top_scripts'), 1);
        add_action('wp_footer', array($this, 'output_body_bottom_scripts'), 1);
        add_action('wp_footer', array($this, 'output_footer_scripts'), 999);
    }

    /**
     * Get active scripts for a specific placement
     *
     * @since 1.0.0
     * @param string $placement The placement location
     * @return array Array of WP_Post objects
     */
    private function get_active_scripts($placement) {
        // Implementation from US-04.2
    }

    /**
     * Filter scripts by scope
     *
     * @since 1.0.0
     * @param array $scripts Array of WP_Post objects
     * @return array Filtered array of scripts
     */
    private function filter_by_scope($scripts) {
        // Implementation from US-04.3
    }

    /**
     * Output scripts for a specific placement
     *
     * @since 1.0.0
     * @param string $placement The placement location
     * @return void
     */
    private function output_scripts($placement) {
        // Implementation from US-04.5
    }

    /**
     * Get current page HTML from all output buffers
     *
     * @since 1.0.0
     * @return string Combined HTML from all buffers
     */
    private function get_current_page_html() {
        // Implementation from TT-04.3
    }

    /**
     * Output scripts in head
     *
     * @since 1.0.0
     * @return void
     */
    public function output_head_scripts() {
        $this->output_scripts('head');
    }

    /**
     * Output scripts in body top
     *
     * @since 1.0.0
     * @return void
     */
    public function output_body_top_scripts() {
        $this->output_scripts('body_top');
    }

    /**
     * Output scripts in body bottom
     *
     * @since 1.0.0
     * @return void
     */
    public function output_body_bottom_scripts() {
        $this->output_scripts('body_bottom');
    }

    /**
     * Output scripts in footer
     *
     * @since 1.0.0
     * @return void
     */
    public function output_footer_scripts() {
        $this->output_scripts('footer');
    }
}
```

## Method Implementations

### get_active_scripts($placement)

**Purpose:** Query and cache scripts for a specific placement

**Logic:**
1. Check cache first
2. If not cached, query with meta_query
3. Filter by scope
4. Cache results
5. Return filtered scripts

**Query Structure:**
```php
$args = array(
    'post_type'      => 'tracking_script',
    'post_status'    => 'publish',
    'posts_per_page' => -1,
    'meta_query'     => array(
        'relation' => 'AND',
        array(
            'key'     => '_gap_placement',
            'value'   => $placement,
            'compare' => '='
        ),
        array(
            'key'     => '_gap_is_active',
            'value'   => '1',
            'compare' => '='
        )
    ),
    'orderby' => 'menu_order title',
    'order'   => 'ASC'
);
```

### filter_by_scope($scripts)

**Purpose:** Filter scripts based on global vs. specific_pages scope

**Logic:**
1. Get current page ID
2. Loop through scripts
3. Include if global
4. Include if specific_pages AND current page in target_pages
5. Return filtered array

### output_scripts($placement)

**Purpose:** Output scripts with duplicate detection

**Logic:**
1. Get active scripts for placement
2. Return early if empty
3. Output opening HTML comment
4. Start output buffering
5. Loop through scripts:
   - Get script content
   - Get extracted IDs
   - Scan page HTML for duplicates
   - Skip if duplicates found (with comment and log)
   - Output if no duplicates
6. End output buffering
7. Output closing HTML comment

### get_current_page_html()

**Purpose:** Capture all HTML generated so far

**Logic:**
1. Get output buffer level
2. Loop through all buffers
3. Capture contents from each
4. Return combined HTML

## WordPress Hooks

### wp_head (priority 1)
- Outputs head scripts
- Early priority ensures scripts load first

### wp_body_open (priority 1)
- Outputs body_top scripts
- Requires WordPress 5.2+
- Early priority for GTM, etc.

### wp_footer (priority 1)
- Outputs body_bottom scripts
- Early priority in footer

### wp_footer (priority 999)
- Outputs footer scripts
- Late priority at very end

## Request-Level Caching

### Cache Structure
```php
$scripts_cache = array(
    'head'        => array(/* WP_Post objects */),
    'body_top'    => array(/* WP_Post objects */),
    'body_bottom' => array(/* WP_Post objects */),
    'footer'      => array(/* WP_Post objects */)
);
```

### Cache Benefits
- Prevents duplicate queries
- Cleared automatically at request end
- No persistent caching needed
- Performance optimized

## Testing Checklist

- [ ] Class loads via autoloader
- [ ] Singleton pattern works
- [ ] Hooks registered correctly
- [ ] get_active_scripts() queries efficiently
- [ ] Caching prevents duplicate queries
- [ ] filter_by_scope() works correctly
- [ ] output_scripts() outputs in correct locations
- [ ] Duplicate detection prevents double-tracking
- [ ] HTML comments added correctly
- [ ] get_current_page_html() captures all buffers
- [ ] All docblocks complete
- [ ] Code follows WordPress coding standards

## Integration Points

### Uses:
- GAP_Conflict_Detector: For duplicate detection
- WordPress: get_posts(), get_the_ID(), etc.

### Used By:
- WordPress hooks (automatically)

### Depends On:
- Autoloader (EPIC-01)
- Meta fields (EPIC-02)
- Conflict Detector (EPIC-03)

## File Header

```php
<?php
/**
 * Frontend Script Output for GA Plugin
 *
 * @package   GA_Plugin
 * @author    Orases
 * @copyright 2025 Orases
 * @license   GPL-2.0-or-later
 * @since     1.0.0
 */

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}
```

## Security Considerations

- [ ] ABSPATH check at top of file
- [ ] HTML comments use esc_html()
- [ ] Script content NOT escaped (already sanitized on save)
- [ ] No direct SQL queries (using get_posts)

## Performance Considerations

- [ ] Request-level caching implemented
- [ ] Maximum 1 query per placement
- [ ] Efficient meta_query usage
- [ ] Minimal buffer overhead

## Definition of Done

- [ ] Class file created
- [ ] All methods implemented
- [ ] Singleton pattern working
- [ ] All hooks registered
- [ ] Caching functional
- [ ] Duplicate detection working
- [ ] All docblocks complete
- [ ] Code passes PHPCS
- [ ] Manual testing complete
- [ ] Integrated with autoloader
- [ ] PR review complete
- [ ] Ready to merge

## Notes

Generated: 2025-10-16

This class is the culmination of all previous work - it brings together CPT, meta fields, conflict detection, and frontend output to deliver the core plugin functionality.
