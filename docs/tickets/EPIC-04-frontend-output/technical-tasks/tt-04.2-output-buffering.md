# TT-04.2: Implement Output Buffering for HTML Scanning

**Ticket Type:** Technical Task
**Epic:** EPIC-04 Frontend Script Output
**Time Estimate:** 1 hour
**File:** `includes/class-gap-frontend.php`

## Description

Implement output buffering functionality within the output_scripts() method to capture page HTML as it's generated, enabling the scan_page_html() method to detect duplicate tracking scripts before outputting new ones.

This is critical for duplicate detection - without capturing the current page state, we can't detect scripts added by themes or other plugins.

## Implementation Steps

1. Start output buffering at beginning of output_scripts()
2. Capture buffer contents before each script output
3. Combine with get_current_page_html() for full context
4. Scan combined HTML for duplicate IDs
5. End buffering and flush after all scripts processed

## Output Buffer Usage

### Integration in output_scripts()

```php
private function output_scripts($placement) {
    $scripts = $this->get_active_scripts($placement);

    if (empty($scripts)) {
        return;
    }

    echo "\n<!-- GA Plugin: " . esc_html($placement) . " -->\n";

    // ================================================
    // START OUTPUT BUFFERING
    // ================================================
    ob_start();

    foreach ($scripts as $script) {
        $content = get_post_meta($script->ID, '_gap_script_content', true);
        $extracted_ids = get_post_meta($script->ID, '_gap_extracted_ids', true);

        if (!empty($extracted_ids) && is_array($extracted_ids)) {
            // ================================================
            // CAPTURE CURRENT BUFFER CONTENTS
            // ================================================
            $current_html = ob_get_contents();

            // Get HTML from all other buffers
            $full_page_html = $this->get_current_page_html();

            // Combine for complete picture
            $combined_html = $current_html . $full_page_html;

            // Scan for duplicates
            $detector = GAP_Conflict_Detector::get_instance();
            $found_ids = $detector->scan_page_html($combined_html, $extracted_ids);

            if (!empty($found_ids)) {
                // Duplicate detected - skip with comment
                $found_id_list = implode(', ', array_column($found_ids, 'id'));

                echo "<!-- GA Plugin: Duplicate tracking script detected for \"" . esc_html(get_the_title($script->ID)) . "\". ";
                echo "IDs already on page: " . esc_html($found_id_list) . ". ";
                echo "Skipping output to prevent double-tracking. -->\n";

                // Log conflict
                $message = sprintf(
                    'Duplicate tracking script detected for "%s". IDs already on page: %s. Skipping output to prevent double-tracking.',
                    get_the_title($script->ID),
                    $found_id_list
                );
                $detector->log_conflict($message);

                continue;
            }
        }

        // No duplicates - output script
        echo $content . "\n";
    }

    // ================================================
    // END OUTPUT BUFFERING AND FLUSH
    // ================================================
    ob_end_flush();

    echo "<!-- /GA Plugin: " . esc_html($placement) . " -->\n\n";
}
```

## Output Buffer Functions

### ob_start()
**Purpose:** Start capturing output
**When:** At beginning of output_scripts()
**Effect:** All echo/print statements go to buffer

### ob_get_contents()
**Purpose:** Get current buffer without clearing
**When:** Before each script output
**Returns:** HTML generated in this buffer so far

### ob_end_flush()
**Purpose:** End buffering and output contents
**When:** After all scripts processed
**Effect:** Buffer contents sent to output

## Why Buffering is Needed

### Problem Without Buffering
```
Page loads → Theme outputs GA script → Plugin outputs same GA script → No way to detect duplicate
```

### Solution With Buffering
```
Page loads → Theme outputs GA script (in buffer)
          → Plugin captures buffer
          → Plugin detects duplicate
          → Plugin skips output
```

## Buffer Capture Flow

### Step 1: Theme/Plugins Output (Before Plugin)
```html
<head>
  <script>gtag('config', 'G-ABC1234567');</script>
  <!-- Other head content -->
```

### Step 2: Plugin's wp_head Hook Fires
```php
ob_start(); // Start capturing plugin output
```

### Step 3: Before First Script
```php
$current_html = ob_get_contents(); // Empty (plugin just started)
$full_page_html = $this->get_current_page_html(); // Contains theme's GA script
$combined_html = $current_html . $full_page_html;
```

### Step 4: Scan Combined HTML
```php
$found_ids = $detector->scan_page_html($combined_html, $extracted_ids);
// Found: G-ABC1234567 (from theme)
```

### Step 5: Skip Duplicate
```php
if (!empty($found_ids)) {
    echo "<!-- Duplicate detected, skipping -->\n";
    continue;
}
```

### Step 6: End Buffering
```php
ob_end_flush(); // Output everything from buffer
```

## Multiple Script Handling

### Scenario: 2 Plugin Scripts, Same ID
```php
// Script A (head placement)
ob_start();
$current_html = ob_get_contents(); // Empty
// No duplicates found → output Script A
// Buffer now contains Script A

// Script B (body_bottom placement)
ob_start();
$current_html = ob_get_contents(); // Empty (new buffer for body_bottom)
$full_page_html = $this->get_current_page_html(); // Contains Script A from head
// Duplicate found → skip Script B
ob_end_flush();
```

## Buffer Level Considerations

### WordPress Buffer Levels
- WordPress core: Level 1
- Theme: Level 2 (possibly)
- Plugins: Level 3+ (possibly)
- Our plugin: Level N+1

### Why get_current_page_html() Needed
```php
private function get_current_page_html() {
    $level = ob_get_level();
    $html = '';

    for ($i = 0; $i < $level; $i++) {
        $html .= ob_get_contents();
    }

    return $html;
}
```

This captures content from ALL buffer levels, not just ours.

## Error Handling

### Buffer Level Check
```php
if (ob_get_level() > 0) {
    $current_html = ob_get_contents();
} else {
    $current_html = '';
}
```

### Ensure Buffer Cleanup
```php
try {
    ob_start();
    // ... script output logic ...
} finally {
    ob_end_flush();
}
```

## Testing Checklist

### Test Case 1: Basic Buffering
1. Add debug logging to output_scripts()
2. Log ob_get_level() before ob_start()
3. Log ob_get_level() after ob_start()
4. Load page
5. Verify level increased by 1

### Test Case 2: Capture Theme Script
1. Add GA script to theme header.php
2. Create plugin script with same ID
3. Load page
4. Verify $current_html empty (plugin just started)
5. Verify $full_page_html contains theme script
6. Verify duplicate detected

### Test Case 3: Capture Previous Plugin Script
1. Create 2 plugin scripts (head and footer)
2. Both with same ID
3. Load page
4. Verify head script outputs
5. Verify footer script detects head script
6. Verify footer script skipped

### Test Case 4: Buffer Cleanup
1. Create script with head placement
2. Load page
3. After page load, check ob_get_level()
4. Verify back to original level (buffer closed)

### Test Case 5: Multiple Buffers
1. Create 4 scripts (one per placement)
2. Load page
3. Verify each placement starts its own buffer
4. Verify each placement ends its buffer
5. Verify no buffer leaks

## Performance Impact

### Buffer Overhead
- Minimal memory usage
- Native PHP function (fast)
- Only active during script output
- Automatically cleared

### Measurement
- Baseline: No buffering
- With buffering: +1-2ms
- Acceptable overhead for duplicate detection

## Dependencies

- TT-04.3: Page HTML Capture (get_current_page_html)
- EPIC-03: Conflict Detector (scan_page_html)

## Definition of Done

- [ ] ob_start() at beginning of output_scripts()
- [ ] ob_get_contents() before each script
- [ ] ob_end_flush() at end of output_scripts()
- [ ] Buffer cleanup guaranteed
- [ ] All test cases passing
- [ ] Performance impact measured
- [ ] Error handling in place
- [ ] Code follows WordPress standards
- [ ] PR review complete
- [ ] Ready to merge

## Notes

Generated: 2025-10-16

Output buffering is the key technique that enables duplicate detection. Without it, we'd have no way to see what's already on the page before adding more scripts.
