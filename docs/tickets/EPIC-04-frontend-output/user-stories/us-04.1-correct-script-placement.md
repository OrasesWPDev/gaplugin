# US-04.1: Load Tracking Scripts in Correct DOM Location

**Ticket Type:** User Story
**Epic:** EPIC-04 Frontend Script Output
**Story Points:** 5
**Time Estimate:** 120 minutes

## Description

As a site visitor, I need tracking scripts loaded in the correct location so that analytics tracking functions properly based on where each script needs to be positioned in the page HTML.

Different tracking scripts require different placement locations (head, body top, body bottom, footer) for optimal performance and functionality. This user story ensures scripts are output at the correct WordPress action hooks.

## Acceptance Criteria

- [ ] Scripts with "head" placement output in wp_head
- [ ] Scripts with "body_top" placement output in wp_body_open
- [ ] Scripts with "body_bottom" placement output in wp_footer (priority 1)
- [ ] Scripts with "footer" placement output in wp_footer (priority 999)
- [ ] HTML comments mark plugin output sections
- [ ] Scripts execute without JavaScript errors

## Implementation Tasks

- [ ] Create GAP_Frontend class skeleton (20 min)
- [ ] Hook wp_head for head placement (15 min)
- [ ] Hook wp_body_open for body_top placement (15 min)
- [ ] Hook wp_footer for body_bottom placement (15 min)
- [ ] Hook wp_footer for footer placement (15 min)
- [ ] Add HTML comment markers (10 min)
- [ ] Test script output in each location (30 min)

## Technical Details

### WordPress Hooks

```php
add_action('wp_head', array($this, 'output_head_scripts'), 1);
add_action('wp_body_open', array($this, 'output_body_top_scripts'), 1);
add_action('wp_footer', array($this, 'output_body_bottom_scripts'), 1);
add_action('wp_footer', array($this, 'output_footer_scripts'), 999);
```

### Hook Priorities

- **Priority 1:** Early execution (head, body_top, body_bottom)
- **Priority 999:** Late execution (footer)

### HTML Comment Markers

```html
<!-- GA Plugin: head -->
<script>/* tracking code */</script>
<!-- /GA Plugin: head -->

<!-- GA Plugin: body_top -->
<script>/* tracking code */</script>
<!-- /GA Plugin: body_top -->

<!-- GA Plugin: body_bottom -->
<script>/* tracking code */</script>
<!-- /GA Plugin: body_bottom -->

<!-- GA Plugin: footer -->
<script>/* tracking code */</script>
<!-- /GA Plugin: footer -->
```

## Placement Locations Explained

### head
- Outputs in `<head>` section
- Loads before page content
- Best for: Critical tracking initialization
- WordPress Hook: `wp_head`

### body_top
- Outputs after opening `<body>` tag
- Loads before visible content
- Best for: Tag managers, priority tracking
- WordPress Hook: `wp_body_open`

### body_bottom
- Outputs before closing `</body>` tag
- Loads after page content
- Best for: Performance-optimized tracking
- WordPress Hook: `wp_footer` (priority 1)

### footer
- Outputs at very end before `</body>`
- Loads after all other scripts
- Best for: Non-critical tracking
- WordPress Hook: `wp_footer` (priority 999)

## Test Cases

### Test Case 1: Head Placement
1. Create tracking script with placement "head"
2. Set to active and global
3. View frontend page source
4. Verify script appears in `<head>` section
5. Verify HTML comments present

### Test Case 2: Body Top Placement
1. Create tracking script with placement "body_top"
2. Set to active and global
3. View frontend page source
4. Verify script appears after `<body>` tag
5. Verify before visible content

### Test Case 3: Body Bottom Placement
1. Create tracking script with placement "body_bottom"
2. Set to active and global
3. View frontend page source
4. Verify script appears before `</body>` tag
5. Verify after page content

### Test Case 4: Footer Placement
1. Create tracking script with placement "footer"
2. Set to active and global
3. View frontend page source
4. Verify script appears at very end
5. Verify after body_bottom scripts

### Test Case 5: Multiple Placements
1. Create 4 scripts (one per placement)
2. All set to active and global
3. View frontend page source
4. Verify all 4 appear in correct locations
5. Verify correct order maintained

### Test Case 6: Script Execution
1. Create script with console.log()
2. Set to active and global
3. Load page in browser
4. Open developer console
5. Verify console.log() executed
6. Verify no JavaScript errors

## Browser Compatibility

Test in:
- Chrome (latest)
- Firefox (latest)
- Safari (latest)
- Edge (latest)

Verify:
- Scripts load correctly
- No console errors
- Proper execution order

## Theme Compatibility Notes

### wp_body_open Hook
- Added in WordPress 5.2
- Not all themes support it
- Fallback: Use wp_footer with early priority
- Document in README as theme requirement

## Dependencies

- EPIC-01: Foundation (autoloader, initialization)
- EPIC-02: Admin Interface (meta fields must be saved)

## Definition of Done

- [ ] Code complete and tested
- [ ] All WordPress hooks registered
- [ ] All placements working correctly
- [ ] HTML comments added
- [ ] All test cases passing
- [ ] Browser compatibility verified
- [ ] Theme compatibility tested
- [ ] Code follows WordPress standards
- [ ] PR review complete
- [ ] Ready to merge

## Notes

Generated: 2025-10-16

Correct placement is critical for tracking accuracy. Some tracking codes (like GTM) specifically require body_top placement to function properly.
