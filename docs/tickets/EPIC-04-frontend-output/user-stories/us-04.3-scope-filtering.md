# US-04.3: Respect Script Scope Settings

**Ticket Type:** User Story
**Epic:** EPIC-04 Frontend Script Output
**Story Points:** 3
**Time Estimate:** 110 minutes

## Description

As an administrator, I need scripts to respect scope settings so that tracking scripts only appear on the pages where they should be active, whether that's globally across the entire site or only on specific selected pages.

This ensures administrators have precise control over where tracking scripts are loaded, preventing unnecessary script execution and enabling page-specific tracking configurations.

## Acceptance Criteria

- [ ] Global scripts output on all pages
- [ ] Specific page scripts only on selected pages
- [ ] Scope checked using get_the_ID()
- [ ] No scripts output on non-singular pages (archives, search) unless global
- [ ] Target pages array compared with strict comparison

## Implementation Tasks

- [ ] Get current page ID with get_the_ID() (10 min)
- [ ] Filter global scripts (always included) (15 min)
- [ ] Filter specific_pages scripts (check page ID) (30 min)
- [ ] Test on homepage (20 min)
- [ ] Test on specific page (20 min)
- [ ] Test on archive page (15 min)

## Technical Details

### Scope Filtering Logic

```php
private function filter_by_scope($scripts) {
    $current_page_id = get_the_ID();
    $filtered_scripts = array();

    foreach ($scripts as $script) {
        $scope = get_post_meta($script->ID, '_gap_scope', true);

        if ('global' === $scope) {
            // Global scripts always included
            $filtered_scripts[] = $script;
        } elseif ('specific_pages' === $scope && $current_page_id) {
            $target_pages = get_post_meta($script->ID, '_gap_target_pages', true);
            if (is_array($target_pages) && in_array($current_page_id, $target_pages, true)) {
                $filtered_scripts[] = $script;
            }
        }
    }

    return $filtered_scripts;
}
```

### Scope Values

**global:**
- Appears on all pages
- Always output regardless of page ID
- No page ID checking needed

**specific_pages:**
- Only appears on selected pages
- Requires current page ID
- Compares with target_pages array

### Page ID Detection

```php
$current_page_id = get_the_ID();
```

**Returns:**
- Post/Page ID on singular pages
- `false` on archives, search, 404, etc.
- Used to filter specific_pages scripts

### Strict Comparison

```php
in_array($current_page_id, $target_pages, true)
```

**Why Strict:**
- Prevents type juggling issues
- Ensures exact ID match
- Avoids false positives

## Test Cases

### Test Case 1: Global Script on Homepage
1. Create script with scope "global"
2. Set to active
3. Load homepage
4. View page source
5. Verify script appears

### Test Case 2: Global Script on Page
1. Use same global script from Test 1
2. Load any page
3. View page source
4. Verify script appears

### Test Case 3: Global Script on Post
1. Use same global script from Test 1
2. Load any post
3. View page source
4. Verify script appears

### Test Case 4: Global Script on Archive
1. Use same global script from Test 1
2. Load category archive
3. View page source
4. Verify script appears (global works on archives)

### Test Case 5: Specific Page Script on Target Page
1. Create script with scope "specific_pages"
2. Select Page A as target
3. Set to active
4. Load Page A
5. View page source
6. Verify script appears

### Test Case 6: Specific Page Script on Other Page
1. Use same script from Test 5 (target: Page A)
2. Load Page B
3. View page source
4. Verify script does NOT appear

### Test Case 7: Specific Page Script on Homepage
1. Use same script from Test 5 (target: Page A)
2. Load homepage
3. View page source
4. Verify script does NOT appear

### Test Case 8: Specific Page Script on Archive
1. Use same script from Test 5 (target: Page A)
2. Load category archive
3. View page source
4. Verify script does NOT appear (no page ID on archives)

### Test Case 9: Multiple Target Pages
1. Create script with scope "specific_pages"
2. Select Page A, Page B, Page C as targets
3. Set to active
4. Load Page A - verify appears
5. Load Page B - verify appears
6. Load Page C - verify appears
7. Load Page D - verify does NOT appear

### Test Case 10: Mixed Global and Specific
1. Create global script
2. Create specific script (target: Page A)
3. Both active
4. Load Page A
5. Verify both scripts appear
6. Load Page B
7. Verify only global script appears

## Edge Cases

### No Page ID Available
- Archives, search, 404 pages
- `get_the_ID()` returns `false`
- Specific page scripts not output
- Global scripts still output

### Empty Target Pages
- Script has scope "specific_pages"
- But target_pages is empty array
- Script never outputs (no matches possible)

### Invalid Page IDs
- Target pages contains deleted page IDs
- Strict comparison prevents false matches
- Script doesn't output on wrong pages

## Integration with Query

```php
private function get_active_scripts($placement) {
    // Query all scripts for this placement
    $scripts = get_posts($args);

    // Filter by scope
    $filtered_scripts = $this->filter_by_scope($scripts);

    return $filtered_scripts;
}
```

## Dependencies

- US-04.2: Efficient Database Queries (provides $scripts array)
- EPIC-02: Admin Interface (scope and target_pages meta fields)

## Definition of Done

- [ ] filter_by_scope() method implemented
- [ ] Global scripts work on all pages
- [ ] Specific scripts only on target pages
- [ ] All test cases passing
- [ ] Edge cases handled correctly
- [ ] Strict comparison used
- [ ] Code follows WordPress standards
- [ ] PR review complete
- [ ] Ready to merge

## Notes

Generated: 2025-10-16

Scope filtering is essential for precise tracking control. The combination of global and specific_pages scopes provides flexibility for any tracking configuration.
