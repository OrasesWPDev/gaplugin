# US-04.4: Duplicate Tracking Prevention on Frontend

**Ticket Type:** User Story
**Epic:** EPIC-04 Frontend Script Output
**Story Points:** 8
**Time Estimate:** 170 minutes

## Description

As a developer, I need duplicate tracking prevention on frontend so that the plugin automatically detects and skips tracking scripts that would create duplicate tracking, preventing data accuracy issues and double-counting.

This is the **key differentiator** of the plugin - it scans the page HTML before outputting each script to ensure tracking IDs aren't already present from themes or other plugins.

## Acceptance Criteria

- [ ] Page HTML scanned before script output
- [ ] Tracking IDs extracted from current script
- [ ] Conflict_Detector->scan_page_html() called
- [ ] Duplicate scripts skipped entirely
- [ ] HTML comment explains why script skipped
- [ ] Conflict logged to debug log
- [ ] Scans all DOM sections (cumulative HTML)

## Implementation Tasks

- [ ] Get extracted IDs from post meta (10 min)
- [ ] Capture current page HTML with output buffering (45 min)
- [ ] Call scan_page_html() with combined HTML (20 min)
- [ ] Skip script output if duplicates found (15 min)
- [ ] Output HTML comment explaining skip (20 min)
- [ ] Call log_conflict() for debugging (10 min)
- [ ] Test with theme GA script (30 min)
- [ ] Test with multiple plugin scripts (20 min)

## Technical Details

### Duplicate Detection Flow

```php
foreach ($scripts as $script) {
    $content = get_post_meta($script->ID, '_gap_script_content', true);
    $extracted_ids = get_post_meta($script->ID, '_gap_extracted_ids', true);

    if (!empty($extracted_ids) && is_array($extracted_ids)) {
        // Get current page HTML
        $current_html = ob_get_contents();
        $full_page_html = $this->get_current_page_html();
        $combined_html = $current_html . $full_page_html;

        // Scan for duplicates
        $detector = GAP_Conflict_Detector::get_instance();
        $found_ids = $detector->scan_page_html($combined_html, $extracted_ids);

        if (!empty($found_ids)) {
            // Script would be duplicate - skip it
            $found_id_list = implode(', ', array_column($found_ids, 'id'));

            echo "<!-- GA Plugin: Duplicate tracking script detected for \"" . esc_html(get_the_title($script->ID)) . "\". ";
            echo "IDs already on page: " . esc_html($found_id_list) . ". ";
            echo "Skipping output to prevent double-tracking. -->\n";

            // Log conflict
            $message = sprintf(
                'Duplicate tracking script detected for "%s". IDs already on page: %s. Skipping output to prevent double-tracking.',
                get_the_title($script->ID),
                $found_id_list
            );
            $detector->log_conflict($message);

            continue; // Skip to next script
        }
    }

    // No duplicates found - output script
    echo $content . "\n";
}
```

### HTML Capture Method

```php
private function get_current_page_html() {
    $level = ob_get_level();
    $html = '';

    for ($i = 0; $i < $level; $i++) {
        $html .= ob_get_contents();
    }

    return $html;
}
```

## HTML Scanning Process

### Step 1: Extract IDs from Script
```php
$extracted_ids = get_post_meta($script->ID, '_gap_extracted_ids', true);
```

Result:
```php
[
    ['id' => 'G-ABC1234567', 'type' => 'ga4', 'name' => 'Google Analytics 4']
]
```

### Step 2: Get Page HTML So Far
```php
$current_html = ob_get_contents(); // Current output buffer
$full_page_html = $this->get_current_page_html(); // All buffers
$combined_html = $current_html . $full_page_html;
```

### Step 3: Scan for Duplicates
```php
$found_ids = $detector->scan_page_html($combined_html, $extracted_ids);
```

If GA4 ID already in HTML:
```php
[
    ['id' => 'G-ABC1234567', 'type' => 'ga4', 'name' => 'Google Analytics 4']
]
```

### Step 4: Handle Result
- **If empty:** No duplicates, output script
- **If not empty:** Duplicates found, skip script with comment

## HTML Comment Format

### When Duplicate Detected
```html
<!-- GA Plugin: Duplicate tracking script detected for "Homepage GA4 Tracking". IDs already on page: G-ABC1234567. Skipping output to prevent double-tracking. -->
```

### When Script Outputs Normally
```html
<!-- GA Plugin: head -->
<script>
  // Tracking code here
</script>
<!-- /GA Plugin: head -->
```

## Test Cases

### Test Case 1: Theme Has GA4 Script
1. Add GA4 script manually to theme header.php
   ```php
   gtag('config', 'G-ABC1234567');
   ```
2. Create plugin script with same GA4 ID
3. Set to active, head placement
4. Load page
5. View page source
6. Verify plugin script NOT output
7. Verify HTML comment explains why
8. Check debug.log for conflict message

### Test Case 2: Plugin Script First
1. Remove theme GA4 script from Test 1
2. Keep plugin script (G-ABC1234567)
3. Load page
4. View page source
5. Verify plugin script outputs normally
6. Verify no skip comment

### Test Case 3: Another Plugin Has GTM
1. Install plugin that outputs GTM-XYZ7890
2. Create GA Plugin script with same GTM ID
3. Set to active
4. Load page
5. Verify GA Plugin script skipped
6. Verify HTML comment present

### Test Case 4: Multiple IDs, Partial Duplicate
1. Theme has G-ABC1234567
2. Create plugin script with G-ABC1234567 AND GTM-XYZ7890
3. Load page
4. Verify script skipped (because G-ABC found)
5. Verify comment lists G-ABC as duplicate

### Test Case 5: No Duplicates
1. Theme has G-111
2. Create plugin script with G-222
3. Load page
4. Verify both scripts output
5. Verify no skip comments

### Test Case 6: Multiple Plugin Scripts
1. Create Script A with G-ABC (head placement)
2. Create Script B with G-ABC (footer placement)
3. Both active and global
4. Load page
5. Verify Script A outputs (first)
6. Verify Script B skipped (duplicate detected)

### Test Case 7: Case Insensitive Detection
1. Theme has 'g-abc1234567' (lowercase)
2. Create plugin script with 'G-ABC1234567'
3. Load page
4. Verify script skipped (case-insensitive match)

### Test Case 8: Script with No IDs
1. Create script with generic JavaScript (no tracking IDs)
2. Set to active
3. Load page
4. Verify script outputs (no IDs to check)
5. Verify no duplicate detection performed

## Debug Log Messages

### Example Log Entry
```
[16-Jan-2025 10:30:45 UTC] GAP Conflict: Duplicate tracking script detected for "Homepage GA4 Tracking". IDs already on page: G-ABC1234567 (Google Analytics 4). Skipping output to prevent double-tracking.
```

### When to Log
- Only when WP_DEBUG is true
- When duplicate detected and skipped
- Includes script title and duplicate IDs

## Output Buffer Considerations

### Why Output Buffering?
- Captures HTML generated so far
- Enables scanning for existing scripts
- Allows detection of theme/plugin scripts
- Critical for duplicate prevention

### Buffer Levels
- WordPress uses multiple buffer levels
- Themes may start buffers
- Plugins may start buffers
- get_current_page_html() checks all levels

## Dependencies

- US-04.2: Efficient Database Queries (provides scripts)
- EPIC-03: Conflict Detection (scan_page_html, log_conflict)

## Definition of Done

- [ ] Duplicate detection implemented
- [ ] HTML scanning working correctly
- [ ] Scripts skipped when duplicates found
- [ ] HTML comments added
- [ ] Conflict logging functional
- [ ] All test cases passing
- [ ] Works with theme scripts
- [ ] Works with plugin scripts
- [ ] Case-insensitive detection verified
- [ ] Code follows WordPress standards
- [ ] PR review complete
- [ ] Ready to merge

## Notes

Generated: 2025-10-16

This is the CORE VALUE PROPOSITION of the plugin. Duplicate prevention ensures accurate analytics data and prevents the double-tracking issues that plague many WordPress sites.
