# US-05.2: Security Audit

**Ticket Type:** User Story
**Epic:** EPIC-05 Testing, Polish & Launch
**Story Points:** 5
**Time Estimate:** 240 minutes

## Description

As a security auditor, I need to verify the plugin is secure so that we can confidently release it without exposing WordPress sites to security vulnerabilities.

This comprehensive security audit covers ABSPATH checks, nonce verification, capability checks, input sanitization, output escaping, and testing for SQL injection, XSS, and CSRF vulnerabilities.

## Acceptance Criteria

- [ ] All files have ABSPATH checks
- [ ] All forms use nonce verification
- [ ] All actions require proper capabilities
- [ ] All inputs sanitized correctly
- [ ] All outputs escaped appropriately
- [ ] No SQL injection vulnerabilities
- [ ] No XSS vulnerabilities
- [ ] No CSRF vulnerabilities

## Implementation Tasks

- [ ] Audit all PHP files for ABSPATH (30 min)
- [ ] Verify nonce usage in all forms (30 min)
- [ ] Verify capability checks (manage_options) (20 min)
- [ ] Review input sanitization (30 min)
- [ ] Review output escaping (30 min)
- [ ] Test for SQL injection attempts (30 min)
- [ ] Test for XSS attempts (30 min)
- [ ] Test for CSRF attempts (20 min)
- [ ] Document security audit results (20 min)

## Security Checklist

### 1. ABSPATH Checks

#### Files to Check:
- [ ] `ga-plugin.php`
- [ ] `includes/class-gap-activator.php`
- [ ] `includes/class-gap-cpt.php`
- [ ] `includes/class-gap-meta-boxes.php`
- [ ] `includes/class-gap-conflict-detector.php`
- [ ] `includes/class-gap-frontend.php`
- [ ] `includes/class-gap-admin.php`

#### Required Code:
```php
if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}
```

#### Test Method:
1. Open each PHP file
2. Check first lines after `<?php`
3. Verify ABSPATH check present
4. Verify exit statement included

### 2. Nonce Verification

#### Meta Box Form
**File:** `includes/class-gap-meta-boxes.php`

**Creation:**
```php
wp_nonce_field('gap_save_meta_box', 'gap_meta_box_nonce');
```

**Verification:**
```php
if (!isset($_POST['gap_meta_box_nonce'])) {
    return;
}

if (!wp_verify_nonce($_POST['gap_meta_box_nonce'], 'gap_save_meta_box')) {
    return;
}
```

#### Test Method:
1. Inspect meta box form HTML
2. Verify nonce field present
3. Check save handler
4. Verify nonce verification code present
5. Test with invalid nonce (should fail)

### 3. Capability Checks

#### Required Capabilities

**CPT Registration:**
```php
'capability_type' => 'post',
'capabilities' => array(
    'edit_post'          => 'manage_options',
    'read_post'          => 'manage_options',
    'delete_post'        => 'manage_options',
    'edit_posts'         => 'manage_options',
    'edit_others_posts'  => 'manage_options',
    'delete_posts'       => 'manage_options',
    'publish_posts'      => 'manage_options',
    'read_private_posts' => 'manage_options',
)
```

**Meta Box Save:**
```php
if (!current_user_can('manage_options', $post_id)) {
    return;
}
```

#### Test Method:
1. Login as Administrator
2. **Expected:** Can access Tracking Scripts
3. **Expected:** Can create/edit scripts
4. Logout
5. Login as Subscriber
6. **Expected:** Cannot access Tracking Scripts
7. **Expected:** Menu not visible

### 4. Input Sanitization

#### Script Content
```php
$content = wp_kses_post(wp_unslash($_POST['gap_script_content']));
```

**Allows:** `<script>`, `<noscript>`, standard HTML
**Removes:** Dangerous tags, attributes, protocols

#### Placement
```php
$placement = sanitize_text_field($_POST['gap_placement']);

$allowed_placements = array('head', 'body_top', 'body_bottom', 'footer');
if (!in_array($placement, $allowed_placements, true)) {
    $placement = 'head'; // Default fallback
}
```

**Sanitizes:** Text field
**Validates:** Whitelist check

#### Scope
```php
$scope = sanitize_text_field($_POST['gap_scope']);

$allowed_scopes = array('global', 'specific_pages');
if (!in_array($scope, $allowed_scopes, true)) {
    $scope = 'global'; // Default fallback
}
```

**Sanitizes:** Text field
**Validates:** Whitelist check

#### Target Pages
```php
$target_pages = array_map('absint', $_POST['gap_target_pages']);
```

**Sanitizes:** Absolute integer (absint)
**Validates:** Ensures positive integers only

#### Active Checkbox
```php
$is_active = isset($_POST['gap_is_active']) ? '1' : '0';
```

**Sanitizes:** Boolean to string ('1' or '0')

#### Test Method:
1. Attempt SQL in script content
2. **Expected:** Sanitized by wp_kses_post
3. Attempt invalid placement value
4. **Expected:** Defaults to 'head'
5. Attempt negative target page ID
6. **Expected:** Converted to 0 (absint)

### 5. Output Escaping

#### Admin Columns
```php
echo esc_html($value);
echo '<a href="' . esc_url($url) . '">';
echo '<span class="' . esc_attr($class) . '">';
```

#### Admin Notices
```php
echo esc_html($message);
```

#### HTML Comments
```php
echo '<!-- GA Plugin: ' . esc_html($placement) . ' -->';
```

#### Script Content (Intentionally NOT Escaped)
```php
echo $content; // Already sanitized with wp_kses_post on save
```

**Note:** Script content must execute as-is for tracking to work.

#### Test Method:
1. Review all echo/print statements
2. Verify appropriate escaping used
3. Confirm script content NOT escaped (by design)

### 6. SQL Injection Testing

#### Database Queries Used
- `get_posts()` - Parameterized internally
- `get_post_meta()` - Parameterized internally
- `update_post_meta()` - Parameterized internally

**No direct `$wpdb` queries used.**

#### Test Method:
1. Attempt SQL in script content:
   ```
   '; DROP TABLE wp_posts; --
   ```
2. **Expected:** Sanitized by wp_kses_post
3. Save and verify
4. **Expected:** No SQL injection
5. Check database tables
6. **Expected:** All intact

### 7. XSS Testing

#### Test Case 1: Script Content
**Input:**
```html
<script>alert('xss')</script>
```

**Expected:** Allowed (this is the purpose of the field)
**But:** Only admins can create scripts
**And:** Already requires manage_options capability

#### Test Case 2: Title Field
**Input:**
```
<script>alert('xss')</script>
```

**Expected:** WordPress sanitizes title automatically
**Expected:** Escaped when displayed in admin columns

#### Test Case 3: Placement Field
**Input:**
```
head<script>alert('xss')</script>
```

**Expected:** Sanitized by sanitize_text_field()
**Expected:** Fails whitelist validation
**Expected:** Defaults to 'head'

#### Test Case 4: Admin Column Output
1. Create script with title containing HTML
2. View Tracking Scripts list
3. **Expected:** HTML entities displayed (not executed)

### 8. CSRF Testing

#### Test Case 1: Missing Nonce
1. Create meta box save request
2. Remove nonce field from POST data
3. Submit form
4. **Expected:** Save fails
5. **Expected:** Returns early from save_meta_boxes()

#### Test Case 2: Invalid Nonce
1. Create meta box save request
2. Modify nonce value to invalid string
3. Submit form
4. **Expected:** wp_verify_nonce() returns false
5. **Expected:** Save fails

#### Test Case 3: Expired Nonce
1. Create meta box save request
2. Wait for nonce to expire (24 hours)
3. Submit form
4. **Expected:** Nonce verification fails
5. **Expected:** Save fails

## Security Audit Report

### Report Template

```markdown
# GA Plugin Security Audit Report

**Date:** [Date]
**Auditor:** [Name]
**Plugin Version:** 1.0.0

## Executive Summary
[Overall security assessment]

## Findings

### Critical Issues
[None expected]

### High Issues
[None expected]

### Medium Issues
[List any medium issues]

### Low Issues
[List any low issues]

### Informational
[List any recommendations]

## Detailed Results

### ABSPATH Checks: ✅ PASS
- All files have ABSPATH checks

### Nonce Verification: ✅ PASS
- Meta box form has nonce
- Save handler verifies nonce

### Capability Checks: ✅ PASS
- CPT requires manage_options
- Meta box save checks capability

### Input Sanitization: ✅ PASS
- Script content: wp_kses_post()
- Placement: sanitize_text_field() + whitelist
- Scope: sanitize_text_field() + whitelist
- Target pages: absint()
- Active: Boolean sanitization

### Output Escaping: ✅ PASS
- Admin columns: esc_html(), esc_url(), esc_attr()
- Admin notices: esc_html()
- HTML comments: esc_html()
- Script content: Intentionally not escaped (required for functionality)

### SQL Injection: ✅ PASS
- No direct SQL queries
- Uses WordPress parameterized functions

### XSS: ✅ PASS
- All outputs escaped except script content
- Script content only editable by admins
- Requires manage_options capability

### CSRF: ✅ PASS
- Nonce verification on all forms
- Nonce properly created and verified

## Recommendations
1. [List any recommendations]

## Sign-off
This plugin has been audited and found to be secure for production use.

**Auditor Signature:** ___________________
**Date:** ___________________
```

## Tools to Use

### WordPress Plugin Check
```bash
wp plugin check ga-plugin
```

### PHP Security Scanner
```bash
phpcs --standard=WordPress-Core includes/
```

### Manual Code Review
- Read each file line by line
- Check for common vulnerabilities
- Verify WordPress best practices

## Dependencies

- All code complete
- EPIC-01, EPIC-02, EPIC-03, EPIC-04 complete

## Definition of Done

- [ ] All security checks completed
- [ ] All vulnerabilities addressed
- [ ] Security audit report written
- [ ] Zero critical or high issues
- [ ] Sign-off from security lead
- [ ] Ready for launch

## Notes

Generated: 2025-10-16

Security is paramount. This audit must be thorough and any issues must be resolved before release. The plugin handles JavaScript code that executes on the frontend, so security is especially important.
