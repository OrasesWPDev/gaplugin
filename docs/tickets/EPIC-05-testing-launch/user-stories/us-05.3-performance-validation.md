# US-05.3: Performance Validation

**Ticket Type:** User Story
**Epic:** EPIC-05 Testing, Polish & Launch
**Story Points:** 3
**Time Estimate:** 155 minutes

## Description

As a performance engineer, I need to verify performance requirements so that the plugin meets our benchmarks for page load impact, database queries, and memory usage without degrading site performance.

This validates that the plugin achieves < 50ms page load impact, ≤ 2 database queries per page, and < 5MB memory usage as specified in the requirements.

## Acceptance Criteria

- [ ] Page load impact < 50ms
- [ ] Database queries ≤ 2 per page load
- [ ] Memory usage < 5MB
- [ ] No N+1 query issues
- [ ] Request-level caching working

## Implementation Tasks

- [ ] Install Query Monitor plugin (10 min)
- [ ] Measure baseline performance (no plugin) (20 min)
- [ ] Measure with plugin active (4 scripts) (20 min)
- [ ] Analyze query count per page (20 min)
- [ ] Measure memory usage (15 min)
- [ ] Verify caching behavior (20 min)
- [ ] Test with 20+ tracking scripts (30 min)
- [ ] Document performance results (20 min)

## Performance Requirements

### Page Load Impact
**Target:** < 50ms
**Measurement:** Total time added by plugin execution
**Tool:** GTmetrix, WebPageTest, or Chrome DevTools

### Database Queries
**Target:** ≤ 2 queries per page load
**Measurement:** Count of queries for tracking script retrieval
**Tool:** Query Monitor plugin

### Memory Usage
**Target:** < 5MB
**Measurement:** Additional memory consumed by plugin
**Tool:** Query Monitor, WP Debug Bar

## Testing Tools Setup

### 1. Query Monitor Plugin

**Installation:**
```bash
wp plugin install query-monitor --activate
```

**Features:**
- Query count
- Query execution time
- Duplicate query detection
- Memory usage
- Hook execution

**Access:**
Admin bar → Query Monitor

### 2. P3 Plugin Profiler

**Installation:**
```bash
wp plugin install p3-profiler --activate
```

**Features:**
- Plugin performance impact
- Query breakdown by plugin
- Load time contribution

**Access:**
Tools → P3 Plugin Profiler

### 3. Debug Bar

**Installation:**
```bash
wp plugin install debug-bar --activate
```

**Requires:**
```php
// wp-config.php
define('WP_DEBUG', true);
```

## Test Scenarios

### Test 1: Baseline Performance

**Steps:**
1. Deactivate GA Plugin
2. Clear all caches
3. Load homepage 3 times (warm cache)
4. Record metrics:
   - Page load time
   - Database queries
   - Memory usage

**Baseline Results Template:**
```
Homepage (No Plugin):
- Load Time: _____ ms
- DB Queries: _____
- Memory: _____ MB
```

### Test 2: Plugin Performance (4 Scripts)

**Setup:**
1. Create 4 tracking scripts:
   - Script A: head placement, global
   - Script B: body_top placement, global
   - Script C: body_bottom placement, global
   - Script D: footer placement, global
2. All active
3. Activate GA Plugin

**Steps:**
1. Clear all caches
2. Load homepage 3 times
3. Record metrics
4. Compare to baseline

**Results Template:**
```
Homepage (With Plugin - 4 Scripts):
- Load Time: _____ ms
- DB Queries: _____
- Memory: _____ MB
- Plugin Impact: _____ ms
```

**Pass Criteria:**
- Plugin impact < 50ms
- Total queries ≤ 6 (baseline + 2)
- Memory increase < 5MB

### Test 3: Query Count Analysis

**Steps:**
1. Activate Query Monitor
2. Load homepage
3. Open Query Monitor
4. Go to "Queries by Component" tab
5. Find "GA Plugin" queries

**Expected Results:**
- Queries by placement (max 4):
  - head: 1 query
  - body_top: 1 query
  - body_bottom: 1 query
  - footer: 1 query
- Total: ≤ 4 queries
- No duplicate queries

**Query Structure Check:**
```sql
SELECT * FROM wp_posts
WHERE post_type = 'tracking_script'
AND post_status = 'publish'
AND (meta_key = '_gap_placement' AND meta_value = 'head')
AND (meta_key = '_gap_is_active' AND meta_value = '1')
```

### Test 4: Caching Verification

**Steps:**
1. Add debug logging:
```php
// In GAP_Frontend::get_active_scripts()
error_log('GAP: Querying scripts for placement: ' . $placement);
```

2. Load homepage
3. Check debug.log
4. Count "Querying scripts" messages

**Expected Results:**
- Maximum 4 log entries (one per placement)
- If same placement called multiple times: only 1 query (cached)

**Cache Hit Rate:**
- First call: Database query
- Subsequent calls: Cache hit (no query)

### Test 5: Memory Usage

**Steps:**
1. Install Query Monitor
2. Load page
3. Check "Environment" panel
4. Record PHP memory usage

**Baseline (No Plugin):**
- Memory: _____ MB

**With Plugin (4 Scripts):**
- Memory: _____ MB
- Increase: _____ MB

**Pass Criteria:**
- Increase < 5MB

### Test 6: Stress Test (20+ Scripts)

**Setup:**
1. Create 20 tracking scripts:
   - 5 head scripts
   - 5 body_top scripts
   - 5 body_bottom scripts
   - 5 footer scripts
2. All active, all global

**Steps:**
1. Load homepage
2. Check Query Monitor
3. Record metrics

**Expected Results:**
- Queries: Still ≤ 4 (one per placement, cached)
- Load time: < 100ms (acceptable for stress test)
- Memory: < 10MB (acceptable for stress test)

**Analysis:**
- Caching should prevent N+1 query problem
- Performance scales with number of placements, not scripts

### Test 7: Page Load Time Impact

**Tool:** GTmetrix or WebPageTest

**Steps:**
1. Go to GTmetrix.com
2. Enter site URL (no plugin)
3. Run test
4. Record "Fully Loaded Time"
5. Activate plugin
6. Run test again
7. Compare results

**Results Template:**
```
Fully Loaded Time:
- Baseline: _____ ms
- With Plugin: _____ ms
- Difference: _____ ms
```

**Pass Criteria:**
- Difference < 50ms

## Performance Benchmarks

### Expected Results

| Metric | Baseline | With Plugin (4 Scripts) | Impact | Target | Status |
|--------|----------|------------------------|--------|--------|--------|
| Load Time | 500ms | 530ms | +30ms | <50ms | ✅ PASS |
| DB Queries | 15 | 19 | +4 | ≤2 per placement | ✅ PASS |
| Memory | 10MB | 12MB | +2MB | <5MB | ✅ PASS |

### Query Breakdown

| Placement | Queries | Cached | Total |
|-----------|---------|--------|-------|
| head | 1 | Yes | 1 |
| body_top | 1 | Yes | 1 |
| body_bottom | 1 | Yes | 1 |
| footer | 1 | Yes | 1 |
| **Total** | **4** | - | **4** |

## Optimization Checklist

### Database Queries
- [ ] Using meta_query (efficient)
- [ ] Request-level caching implemented
- [ ] No duplicate queries
- [ ] Queries only on frontend (not admin)

### Memory Usage
- [ ] No memory leaks
- [ ] Objects cleaned up properly
- [ ] Singleton pattern prevents duplicates
- [ ] Cached data released after request

### Page Load Time
- [ ] Minimal PHP execution
- [ ] No blocking operations
- [ ] Efficient string operations
- [ ] No unnecessary file I/O

## Performance Report Template

```markdown
# GA Plugin Performance Report

**Date:** [Date]
**Tester:** [Name]
**Environment:**
- WordPress: 6.x
- PHP: 8.x
- Theme: [Name]
- Other Plugins: [List]

## Test Configuration
- Tracking Scripts: 4 (one per placement)
- All active, all global
- Pages tested: Homepage, Single Page, Single Post

## Results Summary

### Page Load Impact
- Baseline: _____ ms
- With Plugin: _____ ms
- **Impact: _____ ms** (Target: <50ms)
- Status: ✅ PASS / ❌ FAIL

### Database Queries
- Baseline: _____ queries
- With Plugin: _____ queries
- **Plugin Queries: _____** (Target: ≤2 per placement)
- Status: ✅ PASS / ❌ FAIL

### Memory Usage
- Baseline: _____ MB
- With Plugin: _____ MB
- **Increase: _____ MB** (Target: <5MB)
- Status: ✅ PASS / ❌ FAIL

### Caching Efficiency
- Cache hit rate: _____%
- Duplicate queries: _____
- Status: ✅ PASS / ❌ FAIL

## Detailed Results
[Include Query Monitor screenshots]
[Include GTmetrix reports]

## Recommendations
[List any optimization opportunities]

## Sign-off
Performance requirements: ✅ MET / ❌ NOT MET

**Tester Signature:** ___________________
**Date:** ___________________
```

## Common Performance Issues

### Issue 1: Too Many Queries
**Symptom:** More than 4 queries for plugin
**Cause:** Caching not working
**Solution:** Verify $scripts_cache property

### Issue 2: Slow Queries
**Symptom:** Queries take > 10ms each
**Cause:** Meta keys not indexed
**Solution:** Check database indexes

### Issue 3: High Memory Usage
**Symptom:** Memory increase > 5MB
**Cause:** Large script content or cache not cleared
**Solution:** Profile memory usage, optimize caching

## Dependencies

- All code complete
- EPIC-01, EPIC-02, EPIC-03, EPIC-04 complete
- Query Monitor plugin available

## Definition of Done

- [ ] All performance tests executed
- [ ] All benchmarks met
- [ ] Performance report written
- [ ] Query count ≤ 2 per placement
- [ ] Page load impact < 50ms
- [ ] Memory usage < 5MB
- [ ] Sign-off from performance lead
- [ ] Ready for launch

## Notes

Generated: 2025-10-16

Performance is critical for plugin adoption. Sites won't tolerate plugins that slow down their pages. Our caching strategy should ensure performance scales with placements (max 4), not number of scripts.
